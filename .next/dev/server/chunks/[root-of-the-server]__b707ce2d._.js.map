{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Oma%20kansio/alynappi-klvl/src/app/api/chat/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\nimport { NextResponse } from 'next/server'\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey)\r\nconst MISTRAL_API_KEY = process.env.MISTRAL_API_KEY!\r\n\r\nasync function getEmbedding(text: string) {\r\n  if (!text) throw new Error('Input missing');\r\n  const response = await fetch('https://api.mistral.ai/v1/embeddings', {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${MISTRAL_API_KEY}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({ model: 'mistral-embed', input: [text.replace(/\\n/g, ' ')] })\r\n  })\r\n  const data = await response.json();\r\n  return data.data[0].embedding;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { messages: rawMessages } = await req.json();\r\n\r\n    const messages = rawMessages.map((m: any) => ({\r\n      role: m.role,\r\n      content: typeof m.content === 'string' ? m.content : \r\n               (Array.isArray(m.parts) ? m.parts.find((p: any) => p.type === 'text')?.text || \"\" : \"\")\r\n    }));\r\n\r\n    const userQuestion = messages[messages.length - 1]?.content;\r\n    const queryEmbedding = await getEmbedding(userQuestion);\r\n\r\n    // 2. HAKU (match_threshold ja match_count säädettävissä tässä)\r\n    const { data: matchedSections } = await supabase.rpc('match_documents', {\r\n      query_embedding: queryEmbedding,\r\n      match_threshold: 0.15, //\r\n      match_count: 8         //\r\n    });\r\n\r\n    const contextText = matchedSections?.map((s: any) => `[Lähde: ${s.title}]\\n${s.content}`).join('\\n\\n---\\n\\n');\r\n\r\n    // 3. SYSTEM PROMPT - Äly-Napin aivot ja säännöt palautettu\r\n    const systemPrompt = `\r\nOlet Äly-Nappi, avulias ja empaattinen arkistoavustaja. Tehtäväsi on vastata käyttäjän kysymyksiin annettujen Nappi-lehden tekstiotteiden perusteella.\r\n\r\nSÄÄNNÖT:\r\n  - Käytä vain annettua arkistomateriaalia vastauksen pohjana.\r\n  - Vastaa perusteellisesti ja kattavasti.\r\n  - Käytä selkeitä listoja ja lihavointeja (**tärkeä termi**).\r\n  - Mainitse vastauksessa aina lähteenä käytetyn lehden numero ja vuosi.\r\n  - Jos et löydä tietoa, sano: \"Pahoittelut, tästä aiheesta ei löytynyt mainintoja arkistosta.\"\r\n\r\nLÖYDETTY ARKISTOMATERIAALI:\r\n${contextText || 'Ei suoria osumia arkistosta.'}\r\n`;\r\n\r\n    // 4. MISTRAL KUTSU - Asetukset palautettu (temperature, max_tokens)\r\n    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${MISTRAL_API_KEY}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        model: 'mistral-small-latest', // vaihda malli mistral-large-latest\r\n        messages: [{ role: 'system', content: systemPrompt }, ...messages],\r\n        max_tokens: 500,    //nosta tätä tuotannossa 1000\r\n        temperature: 0.7,\r\n        top_p: 1,\r\n        frequency_penalty: 0,\r\n        presence_penalty: 0,\r\n        stop: null,\r\n        stream: true,\r\n      })\r\n    });\r\n\r\n    const encoder = new TextEncoder();\r\n    const stream = new ReadableStream({\r\n      async start(controller) {\r\n        const reader = response.body?.getReader();\r\n        const decoder = new TextDecoder();\r\n        if (!reader) return controller.close();\r\n\r\n        try {\r\n          let buffer = '';\r\n          while (true) {\r\n            const { done, value } = await reader.read();\r\n            if (done) break;\r\n            \r\n            buffer += decoder.decode(value, { stream: true });\r\n            const lines = buffer.split('\\n');\r\n            buffer = lines.pop() || '';\r\n            \r\n            for (const line of lines) {\r\n              if (line.startsWith('data: ')) {\r\n                const data = line.slice(6).trim();\r\n                if (data === '[DONE]') break;\r\n                try {\r\n                  const json = JSON.parse(data);\r\n                  const text = json.choices?.[0]?.delta?.content;\r\n                  if (text) controller.enqueue(encoder.encode(text));\r\n                } catch (e) {}\r\n              }\r\n            }\r\n          }\r\n          if (buffer && buffer.startsWith('data: ')) {\r\n             try {\r\n               const data = buffer.slice(6).trim();\r\n               if (data !== '[DONE]') {\r\n                 const json = JSON.parse(data);\r\n                 const text = json.choices?.[0]?.delta?.content;\r\n                 if (text) controller.enqueue(encoder.encode(text));\r\n               }\r\n             } catch (e) {}\r\n          }\r\n        } catch (e) {\r\n          controller.error(e);\r\n        } finally {\r\n          controller.close();\r\n        }\r\n      }\r\n    });\r\n\r\n    return new Response(stream, {\r\n      headers: {\r\n        'Content-Type': 'text/event-stream',\r\n        'Cache-Control': 'no-cache',\r\n        'Connection': 'keep-alive',\r\n      },\r\n    });\r\n\r\n  } catch (error: any) {\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}